package com.example.liu.ad_detection.http;

import android.app.Activity;
import android.content.Intent;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;

public class UploadProcess implements Runnable{

    private ServerSocket serverSocket;
    private int port = 12345;
    private Activity activity;

    public UploadProcess(Activity activity) {
        try {
            serverSocket = new ServerSocket(port);
            this.activity = activity;
        } catch (IOException e) {
            System.out.println("ServerSocket打开异常");
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        Socket socket;
        while(true){
            try {
                socket = serverSocket.accept();
                String ip = socket.getInetAddress().toString();
                String port = String.valueOf(socket.getPort());
                System.out.println("连接到" + ip + ":" + port);
            } catch (IOException e) {
                break;
            }

            try {
                HTTPHandler request = HTTPHandler.readHttpHead(socket, HTTPHandler.headType.REQUEST);
                System.out.println(request.showRequestHead());
                //接下来是处理更新进度的逻辑



                Intent intent = new Intent("com.example.liu.broadcasereceiver.MYRECEIVER");
                intent.putExtra("update","notifyDataSetChanged");
                activity.sendBroadcast(intent);     //发送刷新页面的广播
            } catch (Exception e) {
                String ip = socket.getInetAddress().toString();
                String port = String.valueOf(socket.getPort());
                System.out.println("与" + ip + ":" + port + "的通信出现异常");
                break;
            }
        }
    }
}
