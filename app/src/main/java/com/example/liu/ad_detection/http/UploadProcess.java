package com.example.liu.ad_detection.http;

import android.app.Activity;
import android.content.Intent;
import android.util.Log;
import android.widget.Toast;
import com.example.liu.ad_detection.model.AppInfo;
import com.example.liu.ad_detection.uploadingFragment;

import java.io.IOException;
import java.net.Socket;
import java.util.HashMap;
import java.util.Map;


public class UploadProcess implements Runnable{

    private Activity activity;

    public UploadProcess(Activity activity) {
            this.activity = activity;
    }

    @Override
    public void run() {
        while (true){
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            Log.d("Hash","==================="+uploadingFragment.uploadingList.size());
            if (uploadingFragment.uploadingList.size() > 0){
                String hash = "";
                for (AppInfo app:uploadingFragment.uploadingList) {
                    hash += app.getHash()+"&";
                }
                Log.d("Hash",hash);
                Socket socket = null;
                try {
                    socket = new Socket(IP.ip, 12345);
                    HTTPHandler request = new HTTPHandler();
                    request.setObject(HTTPHandler.object.MESSAGE);
                    request.setMethod(HTTPHandler.method.PROCESS);
                    request.setContent((hash).getBytes());

                    HTTPHandler reponse = HTTPHandler.sendRequestAndReadReponse(socket, request);
                    Log.d("uploadProcess",reponse.showReponseHead());
                    if(reponse.hasContent()){
                        String content = new String(reponse.getContent());
                        HashMap<String, String> fileSize = HTTPHandler.paraStrToHashMap(content);
                        for (Map.Entry<String,String> file:fileSize.entrySet()) {
                            for (AppInfo appInfo:uploadingFragment.uploadingList){
                                if (file.getKey().equals(appInfo.getHash())){
                                    appInfo.setProcess((int)((Float.valueOf(file.getValue())/Float.valueOf(appInfo.getSize()))*100));
                                    Log.d("uploadProcess",appInfo.getProcess()+"");
                                }
                            }
                        }
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
                if (activity != null) {   //如果退出了这个界面，ACtivity被销毁，获取不到就会报错
                    activity.runOnUiThread(new Runnable() {
                        @Override
                        public void run() {
                            Intent intent = new Intent("com.example.liu.broadcasereceiver.MYRECEIVER");
                            intent.putExtra("update","notifyDataSetChanged");
                            activity.sendBroadcast(intent);     //发送刷新页面的广播
                        }
                    });
                }
            }
        }
    }
}
